<!-- user.wxml -->
<view class="container">
  <!-- Not Logged In -->
  <view wx:if="{{!isLoggedIn}}" class="not-logged-in">
    <image class="login-banner" src="../../images/icon/èµ›äº‹icon.png" mode="aspectFit"/>
    <view class="login-text">è¯·ç™»å½•æŸ¥çœ‹æ‚¨çš„ä¸ªäººèµ„æ–™</view>
    <button class="btn-login" bindtap="login">ç™»å½• / æ³¨å†Œ</button>
  </view>
  
  <!-- Logged In -->
  <block wx:else>
    <!-- Loading State -->
    <view wx:if="{{loading}}" class="loading-state">
      <view class="loading-spinner"></view>
      <view class="loading-text">åŠ è½½ä¸ªäººèµ„æ–™ä¸­...</view>
    </view>
    
    <!-- Profile Content -->
    <block wx:elif="{{profile}}">
      <!-- Profile Header -->
      <view class="profile-header">
        <!-- Background Image -->
        <image
          class="profile-background"
          src="{{profile.backgroundImage || '../../images/default-bg.jpg'}}"
          mode="aspectFill"
        />
        <view class="profile-header-overlay"></view>

        <view class="profile-header-content">
          <image
            class="profile-avatar"
            src="{{profile.avatar || '../../images/icon/æˆ‘çš„icon.png'}}"
            mode="aspectFill"
          />
          <view class="profile-info">
            <view class="profile-name">{{profile.nickname || 'ç½‘çƒé€‰æ‰‹'}}</view>
            <view class="profile-id">ID: {{profile.customId || profile.id || 'N/A'}}</view>
            <view wx:if="{{profile.signature}}" class="profile-signature">{{profile.signature}}</view>
          </view>
          <view class="profile-actions">
            <view class="profile-edit" bindtap="editProfile">
              <image class="edit-icon" src="../../images/icon/ç¼–è¾‘.png" mode="aspectFit"/>
            </view>
            <view class="profile-logout" bindtap="logout">
              <image class="logout-icon" src="../../images/icon/è®¾ç½®.png" mode="aspectFit"/>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Enhanced Stats Summary -->
      <view class="stats-summary">
        <view class="stat-item" bindtap="viewDetailedStats">
          <view class="stat-value">{{userStats ? userStats.basic.participationCount : (profile.stats.participationCount || 0)}}</view>
          <view class="stat-label">æ¯”èµ›</view>
        </view>
        <view class="stat-item" bindtap="viewDetailedStats">
          <view class="stat-value">{{userStats ? userStats.basic.wins : (profile.stats.wins || 0)}}</view>
          <view class="stat-label">èƒœåœº</view>
        </view>
        <view class="stat-item" bindtap="viewDetailedStats">
          <view class="stat-value">{{userStats ? userStats.basic.winRate : (profile.stats.winRate || '0%')}}</view>
          <view class="stat-label">èƒœç‡</view>
        </view>
        <view class="stat-item" bindtap="viewDetailedStats">
          <view class="stat-value">{{userStats ? userStats.basic.etaPoints : (profile.stats.etaPoints || 0)}}</view>
          <view class="stat-label">ç§¯åˆ†</view>
        </view>
      </view>
      
      <!-- User Level and Achievements -->
      <view class="level-achievements-section">
        <view class="level-info">
          <view class="level-badge">
            <text class="level-name">{{userStats ? userStats.level.name : 'æ–°æ‰‹'}}</text>
          </view>
          <view class="achievements-info" bindtap="viewAchievements">
            <text class="achievements-count">ğŸ† {{achievements.length}} ä¸ªæˆå°±</text>
            <text class="achievements-hint">ç‚¹å‡»æŸ¥çœ‹</text>
          </view>
        </view>
      </view>
      
      <!-- Quick Actions -->
      <view class="quick-actions">
        <view class="action-item" bindtap="searchUsers">
          <image class="action-icon" src="../../images/icon/æœç´¢.png" mode="aspectFit"/>
          <text class="action-text">æœç´¢ç”¨æˆ·</text>
        </view>
        <view class="action-item" bindtap="editProfile">
          <image class="action-icon" src="../../images/icon/ç¼–è¾‘.png" mode="aspectFit"/>
          <text class="action-text">ç¼–è¾‘èµ„æ–™</text>
        </view>
      </view>
      
      <!-- Leaderboard Section -->
      <view class="section leaderboard-section">
        <view class="section-header">
          <view class="section-title">æ’è¡Œæ¦œ</view>
          <view class="leaderboard-tabs">
            <view 
              class="tab-item {{leaderboardType === 'points' ? 'active' : ''}}"
              bindtap="switchLeaderboardType"
              data-type="points"
            >ç§¯åˆ†</view>
            <view 
              class="tab-item {{leaderboardType === 'wins' ? 'active' : ''}}"
              bindtap="switchLeaderboardType"
              data-type="wins"
            >èƒœåœº</view>
            <view 
              class="tab-item {{leaderboardType === 'participation' ? 'active' : ''}}"
              bindtap="switchLeaderboardType"
              data-type="participation"
            >å‚ä¸</view>
          </view>
        </view>
        
        <view class="section-content">
          <view wx:if="{{leaderboard.length === 0}}" class="empty-text">æ’è¡Œæ¦œåŠ è½½ä¸­...</view>
          <view wx:else class="leaderboard-list">
            <view 
              wx:for="{{leaderboard}}" 
              wx:key="id" 
              class="leaderboard-item {{index < 3 ? 'top-three' : ''}}"
            >
              <view class="rank-badge rank-{{index + 1}}">{{item.rank}}</view>
              <image class="user-avatar" src="../../images/icon/æˆ‘çš„icon.png" mode="aspectFit"/>
              <view class="user-info">
                <view class="user-name">{{item.nickname}}</view>
                <view class="user-level">{{item.level.name}}</view>
              </view>
              <view class="user-score">
                <text wx:if="{{leaderboardType === 'points'}}">{{item.stats.etaPoints}}</text>
                <text wx:elif="{{leaderboardType === 'wins'}}">{{item.stats.wins}}</text>
                <text wx:else>{{item.stats.participationCount}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Clubs Section -->
      <view class="section clubs-section">
        <view class="section-header">
          <view class="section-title">æˆ‘çš„ä¿±ä¹éƒ¨</view>
        </view>
        
        <view class="section-content">
          <view wx:if="{{clubsLoading}}" class="loading-mini">åŠ è½½ä¿±ä¹éƒ¨ä¸­...</view>
          <view wx:elif="{{clubs.length === 0}}" class="empty-text">æ‚¨è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•ä¿±ä¹éƒ¨ï¼Œå¿«å»æ¢ç´¢æˆ–åˆ›å»ºæ‚¨çš„ä¿±ä¹éƒ¨å§ï¼</view>
          <view wx:else class="clubs-list">
            <view 
              wx:for="{{clubs}}" 
              wx:key="id" 
              class="club-item"
              bindtap="goToClubDetail"
              data-id="{{item.id}}"
            >
              <image class="club-logo" src="../../images/icon/åœºé¦†icon.png" mode="aspectFit"/>
              <view class="club-info">
                <view class="club-name">{{item.name}}</view>
                <view class="club-points">{{item.points || 0}} ç§¯åˆ†</view>
              </view>
              <image class="arrow-icon" src="../../images/icon/è®¢å•.png" mode="aspectFit"/>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Match History Section -->
      <view class="section match-section">
        <view class="section-header">
          <view class="section-title">æ¯”èµ›è®°å½•</view>
        </view>
        
        <!-- Match Filters -->
        <view class="match-filters">
          <view class="filter-group">
            <view 
              class="filter-item {{matchFilters.type === 'all' ? 'active' : ''}}"
              bindtap="applyMatchFilter"
              data-field="type"
              data-value="all"
            >å…¨éƒ¨ç±»å‹</view>
            <view 
              class="filter-item {{matchFilters.type === 'singles' ? 'active' : ''}}"
              bindtap="applyMatchFilter"
              data-field="type"
              data-value="singles"
            >å•æ‰“</view>
            <view 
              class="filter-item {{matchFilters.type === 'doubles' ? 'active' : ''}}"
              bindtap="applyMatchFilter"
              data-field="type"
              data-value="doubles"
            >åŒæ‰“</view>
          </view>
          
          <view class="filter-group">
            <view 
              class="filter-item {{matchFilters.status === 'all' ? 'active' : ''}}"
              bindtap="applyMatchFilter"
              data-field="status"
              data-value="all"
            >å…¨éƒ¨çŠ¶æ€</view>
            <view 
              class="filter-item {{matchFilters.status === 'completed' ? 'active' : ''}}"
              bindtap="applyMatchFilter"
              data-field="status"
              data-value="completed"
            >å·²å®Œæˆ</view>
            <view 
              class="filter-item {{matchFilters.status === 'upcoming' ? 'active' : ''}}"
              bindtap="applyMatchFilter"
              data-field="status"
              data-value="upcoming"
            >å³å°†å¼€å§‹</view>
          </view>
        </view>
        
        <!-- Match List -->
        <view class="section-content">
          <view wx:if="{{matchesLoading && matches.length === 0}}" class="loading-mini">åŠ è½½æ¯”èµ›ä¸­...</view>
          <view wx:elif="{{matches.length === 0}}" class="empty-text">æš‚æ— æ¯”èµ›è®°å½•ï¼Œå¿«å»æŠ¥åå‚åŠ ä¸€åœºæ¯”èµ›å§ï¼</view>
          <view wx:else class="match-list">
            <view 
              wx:for="{{matches}}" 
              wx:key="id" 
              class="match-item"
              bindtap="goToMatchDetail"
              data-id="{{item._id}}"
            >
              <view class="match-item-header">
                <text>{{item.eventType}}</text>
                <text class="status-label {{item.status ? 'status-' + item.status : ''}}">
                  {{item.stage || 'Match'}}
                </text>
              </view>
              
              <view class="match-item-content">
                <view class="match-players">
                  <view class="match-player">{{item.players[0].name}}</view>
                  <view class="match-vs">VS</view>
                  <view class="match-player">{{item.players[1].name}}</view>
                </view>
                
                <view class="match-info">
                  <view class="match-date">{{item.date || 'N/A'}}</view>
                  <view class="match-venue">{{item.venue || 'N/A'}}</view>
                </view>
              </view>
            </view>
          </view>
          
          <!-- Load More -->
          <view wx:if="{{hasMoreMatches && !matchesLoading && matches.length > 0}}" class="load-more" bindtap="loadMoreMatches">
            åŠ è½½æ›´å¤š
          </view>
          
          <!-- Loading More -->
          <view wx:if="{{matchesLoading && matches.length > 0}}" class="loading-mini">
            åŠ è½½æ›´å¤šä¸­...
          </view>
        </view>
      </view>
    </block>
  </block>
</view>