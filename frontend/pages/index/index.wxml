<!-- index.wxml -->
<view class="container">
  <!-- Header -->
  <view class="header">
    <view class="title">ç½‘çƒçƒ­</view>
    <view class="header-actions">
      <view class="stats-btn" bindtap="viewMatchStats">
        <text class="stats-icon">ğŸ“Š</text>
      </view>
      <view class="search-btn" bindtap="toggleSearch">
        <text class="search-icon">ğŸ”</text>
      </view>
    </view>
  </view>
  
  <!-- Search Bar -->
  <view class="search-bar {{showSearch ? 'show' : ''}}">
    <input 
      class="search-input" 
      placeholder="æœç´¢æ¯”èµ›ã€é€‰æ‰‹æˆ–åœºåœ°" 
      value="{{searchQuery}}"
      bindinput="onSearchInput"
      bindconfirm="onSearch"
    />
    <view class="search-action" bindtap="onSearch">
      <text class="search-action-icon">ğŸ”</text>
    </view>
    <view class="search-clear" bindtap="onClearSearch" wx:if="{{searchQuery}}">
      <text>âœ•</text>
    </view>
  </view>
  
  <!-- Search Results -->
  <view class="search-results" wx:if="{{showSearch && searchQuery}}">
    <view wx:if="{{searchLoading}}" class="search-loading">
      <view class="loading-spinner"></view>
      <text>æœç´¢ä¸­...</text>
    </view>
    <view wx:elif="{{searchResults.length > 0}}" class="search-list">
      <view 
        wx:for="{{searchResults}}" 
        wx:key="_id" 
        class="search-item"
        bindtap="goToDetail"
        data-id="{{item._id}}"
      >
        <view class="search-item-title">{{item.matchName || item.eventType}}</view>
        <view class="search-item-info">
          <text class="search-item-venue">{{item.venue}}</text>
          <text class="search-item-time">{{formatMatchTime(item.scheduledTime)}}</text>
        </view>
      </view>
    </view>
    <view wx:elif="{{searchQuery.length >= 2}}" class="search-empty">
      <text>æœªæ‰¾åˆ°ç›¸å…³æ¯”èµ›</text>
    </view>
  </view>
  
  <!-- Live Matches Banner -->
  <view class="live-banner" wx:if="{{liveMatches.length > 0}}" bindtap="goToLiveMatches">
    <view class="live-indicator">
      <text class="live-dot">â—</text>
      <text class="live-text">{{liveMatches.length}}åœºæ¯”èµ›æ­£åœ¨è¿›è¡Œ</text>
    </view>
    <view class="live-arrow">></view>
  </view>
  
  <!-- Top Tab Navigation -->
  <view class="tab-nav">
    <view 
      wx:for="{{tabs}}" 
      wx:key="index" 
      class="tab-item {{activeTab === index ? 'active' : ''}}"
      bindtap="switchTab"
      data-index="{{index}}"
    >
      {{item}}
    </view>
  </view>
  
  <!-- Enhanced Filter Bar -->
  <view class="filter-bar">
    <view class="filter-title">æ¯”èµ›ç­›é€‰</view>
    <view class="filter-btn" bindtap="toggleFilter">
      <text>ç­›é€‰</text>
      <text class="filter-icon">ğŸ”</text>
    </view>
  </view>
  
  <!-- Filter Panel (Hidden by default) -->
  <view class="filter-panel {{showFilter ? 'show' : ''}}">
    <view class="filter-section">
      <view class="filter-section-title">èµ›äº‹ç±»å‹</view>
      <view class="filter-options">
        <view 
          wx:for="{{eventTypes}}" 
          wx:key="id" 
          class="filter-option {{filters.eventType === item.id ? 'active' : ''}}"
          bindtap="applyFilter"
          data-field="eventType"
          data-value="{{item.id}}"
        >
          {{item.name}}
        </view>
      </view>
    </view>
    
    <view class="filter-section">
      <view class="filter-section-title">é€‰æ‰‹æœç´¢</view>
      <input 
        class="filter-input" 
        placeholder="æŒ‰é€‰æ‰‹å§“åæœç´¢" 
        value="{{filters.player}}"
        bindinput="inputPlayer"
      />
    </view>
    
    <view class="filter-section">
      <view class="filter-section-title">åœ°åŒº</view>
      <input 
        class="filter-input" 
        placeholder="æŒ‰åœ°åŒºæœç´¢" 
        value="{{filters.region}}"
        bindinput="inputRegion"
      />
    </view>
    
    <view class="filter-actions">
      <button class="btn-reset" bindtap="resetFilter">é‡ç½®</button>
      <button class="btn-apply" bindtap="toggleFilter">åº”ç”¨</button>
    </view>
  </view>
  
  <!-- Match List -->
  <view class="match-list">
    <block wx:if="{{matches.length > 0}}">
      <!-- æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤ºæ¯”èµ› -->
      <view wx:for="{{matches}}" wx:for-item="dateGroup" wx:key="date" class="date-group">
        <!-- æ—¥æœŸæ ‡é¢˜ -->
        <view class="date-header">
          <text class="date-display">{{dateGroup.dateDisplay}}</text>
        </view>
        
        <!-- è¯¥æ—¥æœŸä¸‹çš„æ¯”èµ›åˆ—è¡¨ -->
        <view wx:for="{{dateGroup.matches}}" wx:for-item="match" wx:key="_id" class="match-card">
          <!-- æ¯”èµ›ç±»å‹å’ŒçŠ¶æ€ -->
          <view class="match-header">
            <view class="match-type">{{match.eventType}}</view>
            <view class="match-status">
              <text class="status-label {{match.status === 'å·²ç»“æŸ' ? 'status-completed' : match.status === 'æ¯”èµ›ä¸­' ? 'status-ongoing' : 'status-registration'}}">
                <text wx:if="{{match.status === 'æ¯”èµ›ä¸­'}}" class="live-dot">â—</text>
                {{match.status === 'å·²ç»“æŸ' ? 'å·²ç»“æŸ' : match.status === 'æ¯”èµ›ä¸­' ? 'è¿›è¡Œä¸­' : 'æŠ¥åä¸­'}}
              </text>
            </view>
          </view>
          
          <!-- æ¯”èµ›åœºåœ°å’Œæ—¶é—´ä¿¡æ¯ -->
          <view class="match-info">
            <text class="venue-info">ğŸ“ {{match.venue}} - {{match.stage}}</text>
            <text class="time-info">ğŸ• {{formatMatchTime(match.scheduledTime)}}</text>
            <text class="region-info">ğŸŒ {{match.region}}</text>
          </view>
          
          <!-- é€‰æ‰‹å’Œæ¯”åˆ† -->
          <view class="players-section">
            <!-- é˜Ÿä¼1 -->
            <view class="team-row {{match.score && match.score.winner === 'team1' ? 'winner' : ''}}">
              <view class="team-players">
                <view wx:for="{{match.players.team1}}" wx:for-item="player" wx:for-index="playerIndex" wx:key="playerIndex" class="player">
                  <text class="player-name">{{player.name}}</text>
                  <text class="player-ranking">({{player.ranking}})</text>
                </view>
              </view>
              
              <!-- é˜Ÿä¼1æ¯”åˆ† -->
              <view class="team-score">
                <view wx:for="{{match.score.sets}}" wx:for-item="set" wx:key="setNumber" 
                      class="set-score {{set.team1Score > set.team2Score ? 'winner' : ''}}">
                  {{set.team1Score}}
                  <text wx:if="{{set.tiebreak && set.tiebreak.played}}" class="tiebreak-score">({{set.tiebreak.team1Score}})</text>
                </view>
              </view>
            </view>
            
            <!-- VS åˆ†éš”ç¬¦ -->
            <view class="vs-divider">
              <text wx:if="{{match.score.winner}}" class="winner-mark">{{match.score.winner === 'team1' ? 'âœ“' : ''}}</text>
              <text class="vs-text">VS</text>
              <text wx:if="{{match.score.winner}}" class="winner-mark">{{match.score.winner === 'team2' ? 'âœ“' : ''}}</text>
            </view>
            
            <!-- é˜Ÿä¼2 -->
            <view class="team-row {{match.score && match.score.winner === 'team2' ? 'winner' : ''}}">
              <view class="team-players">
                <view wx:for="{{match.players.team2}}" wx:for-item="player" wx:for-index="playerIndex" wx:key="playerIndex" class="player">
                  <text class="player-name">{{player.name}}</text>
                  <text class="player-ranking">({{player.ranking}})</text>
                </view>
              </view>
              
              <!-- é˜Ÿä¼2æ¯”åˆ† -->
              <view class="team-score">
                <view wx:for="{{match.score.sets}}" wx:for-item="set" wx:key="setNumber" 
                      class="set-score {{set.team2Score > set.team1Score ? 'winner' : ''}}">
                  {{set.team2Score}}
                  <text wx:if="{{set.tiebreak && set.tiebreak.played}}" class="tiebreak-score">({{set.tiebreak.team2Score}})</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- æ¯”èµ›ç»Ÿè®¡ä¿¡æ¯ -->
          <view class="match-stats" wx:if="{{match.matchStats}}">
            <view class="stat-item">
              <text class="stat-icon">ğŸ‘¥</text>
              <text class="stat-value">{{match.matchStats.spectatorCount || 0}}</text>
            </view>
            <view class="stat-item">
              <text class="stat-icon">ğŸ‘</text>
              <text class="stat-value">{{match.matchStats.viewCount || 0}}</text>
            </view>
            <view class="stat-item" wx:if="{{match.matchStats.duration}}">
              <text class="stat-icon">â±</text>
              <text class="stat-value">{{match.matchStats.duration}}</text>
            </view>
          </view>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="match-actions">
            <button wx:if="{{match.status === 'æŠ¥åä¸­'}}" 
                    class="btn-register" 
                    catchtap="registerMatch" 
                    data-id="{{match._id}}">
              æŠ¥åå‚èµ›
            </button>
            <view wx:elif="{{match.status === 'æ¯”èµ›ä¸­'}}" class="action-group">
              <button class="btn-spectator" 
                      catchtap="joinAsSpectator" 
                      data-id="{{match._id}}">
                <text class="action-icon">ğŸ‘</text>
                <text class="action-text">è§‚çœ‹</text>
              </button>
              <button class="btn-detail" 
                      catchtap="goToDetail" 
                      data-id="{{match._id}}">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </view>
            <button wx:else 
                    class="btn-detail" 
                    catchtap="goToDetail" 
                    data-id="{{match._id}}">
              æŸ¥çœ‹è¯¦æƒ…
            </button>
          </view>
        </view>
      </view>
    </block>
    
    <!-- Skeleton Loader -->
    <block wx:if="{{loading && matches.length === 0}}">
      <view class="skeleton-card">
        <view class="skeleton-header"></view>
        <view class="skeleton-content">
          <view class="skeleton-row">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-text-group">
              <view class="skeleton-text short"></view>
              <view class="skeleton-text long"></view>
            </view>
          </view>
          <view class="skeleton-row">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-text-group">
              <view class="skeleton-text short"></view>
              <view class="skeleton-text long"></view>
            </view>
          </view>
          <view class="skeleton-right-section"></view>
        </view>
      </view>
      <view class="skeleton-card">
        <view class="skeleton-header"></view>
        <view class="skeleton-content">
          <view class="skeleton-row">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-text-group">
              <view class="skeleton-text short"></view>
              <view class="skeleton-text long"></view>
            </view>
          </view>
          <view class="skeleton-row">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-text-group">
              <view class="skeleton-text short"></view>
              <view class="skeleton-text long"></view>
            </view>
          </view>
          <view class="skeleton-right-section"></view>
        </view>
      </view>
    </block>

    <!-- Empty State -->
    <view wx:if="{{!loading && matches.length === 0}}" class="empty-state">
      <text class="empty-icon">ğŸ“­</text>
      <view class="empty-text">æš‚æ— æ¯”èµ›æ•°æ®ï¼Œå°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–ç¨åå†è¯•ã€‚</view>
    </view>
    
    <!-- Loading State -->
    <view wx:if="{{loading}}" class="loading-state">
      <view class="loading-spinner"></view>
      <view class="loading-text">åŠ è½½ä¸­...</view>
    </view>
    
    <!-- Load More -->
    <view wx:if="{{hasMore && !loading && matches.length > 0}}" class="load-more" bindtap="loadMoreMatches">
      åŠ è½½æ›´å¤š
    </view>
  </view>
</view> 