<!-- index.wxml -->
<view class="container">
  <!-- Header -->
  <view class="header">
    <view class="title">网球热</view>
    <view class="header-actions">
      <view class="stats-btn" bindtap="viewMatchStats">
        <text class="stats-icon">📊</text>
      </view>
      <view class="search-btn" bindtap="toggleSearch">
        <text class="search-icon">🔍</text>
      </view>
    </view>
  </view>
  
  <!-- Search Bar -->
  <view class="search-bar {{showSearch ? 'show' : ''}}">
    <input 
      class="search-input" 
      placeholder="搜索比赛、选手或场地" 
      value="{{searchQuery}}"
      bindinput="onSearchInput"
      bindconfirm="onSearch"
    />
    <view class="search-action" bindtap="onSearch">
      <text class="search-action-icon">🔍</text>
    </view>
    <view class="search-clear" bindtap="onClearSearch" wx:if="{{searchQuery}}">
      <text>✕</text>
    </view>
  </view>
  
  <!-- Search Results -->
  <view class="search-results" wx:if="{{showSearch && searchQuery}}">
    <view wx:if="{{searchLoading}}" class="search-loading">
      <view class="loading-spinner"></view>
      <text>搜索中...</text>
    </view>
    <view wx:elif="{{searchResults.length > 0}}" class="search-list">
      <view 
        wx:for="{{searchResults}}" 
        wx:key="_id" 
        class="search-item"
        bindtap="goToDetail"
        data-id="{{item._id}}"
      >
        <view class="search-item-title">{{item.matchName || item.eventType}}</view>
        <view class="search-item-info">
          <text class="search-item-venue">{{item.venue}}</text>
          <text class="search-item-time">{{formatMatchTime(item.scheduledTime)}}</text>
        </view>
      </view>
    </view>
    <view wx:elif="{{searchQuery.length >= 2}}" class="search-empty">
      <text>未找到相关比赛</text>
    </view>
  </view>
  
  <!-- Live Matches Banner -->
  <view class="live-banner" wx:if="{{liveMatches.length > 0}}" bindtap="goToLiveMatches">
    <view class="live-indicator">
      <text class="live-dot">●</text>
      <text class="live-text">{{liveMatches.length}}场比赛正在进行</text>
    </view>
    <view class="live-arrow">></view>
  </view>
  
  <!-- Top Tab Navigation -->
  <view class="tab-nav">
    <view 
      wx:for="{{tabs}}" 
      wx:key="index" 
      class="tab-item {{activeTab === index ? 'active' : ''}}"
      bindtap="switchTab"
      data-index="{{index}}"
    >
      {{item}}
    </view>
  </view>
  
  <!-- Enhanced Filter Bar -->
  <view class="filter-bar">
    <view class="filter-title">比赛筛选</view>
    <view class="filter-btn" bindtap="toggleFilter">
      <text>筛选</text>
      <text class="filter-icon">🔍</text>
    </view>
  </view>
  
  <!-- Filter Panel (Hidden by default) -->
  <view class="filter-panel {{showFilter ? 'show' : ''}}">
    <view class="filter-section">
      <view class="filter-section-title">赛事类型</view>
      <view class="filter-options">
        <view 
          wx:for="{{eventTypes}}" 
          wx:key="id" 
          class="filter-option {{filters.eventType === item.id ? 'active' : ''}}"
          bindtap="applyFilter"
          data-field="eventType"
          data-value="{{item.id}}"
        >
          {{item.name}}
        </view>
      </view>
    </view>
    
    <view class="filter-section">
      <view class="filter-section-title">选手搜索</view>
      <input 
        class="filter-input" 
        placeholder="按选手姓名搜索" 
        value="{{filters.player}}"
        bindinput="inputPlayer"
      />
    </view>
    
    <view class="filter-section">
      <view class="filter-section-title">地区</view>
      <input 
        class="filter-input" 
        placeholder="按地区搜索" 
        value="{{filters.region}}"
        bindinput="inputRegion"
      />
    </view>
    
    <view class="filter-actions">
      <button class="btn-reset" bindtap="resetFilter">重置</button>
      <button class="btn-apply" bindtap="toggleFilter">应用</button>
    </view>
  </view>
  
  <!-- Match List -->
  <view class="match-list">
    <block wx:if="{{matches.length > 0}}">
      <!-- 按日期分组显示比赛 -->
      <view wx:for="{{matches}}" wx:for-item="dateGroup" wx:key="date" class="date-group">
        <!-- 日期标题 -->
        <view class="date-header">
          <text class="date-display">{{dateGroup.dateDisplay}}</text>
        </view>
        
        <!-- 该日期下的比赛列表 -->
        <view wx:for="{{dateGroup.matches}}" wx:for-item="match" wx:key="_id" class="match-card">
          <!-- 比赛类型和状态 -->
          <view class="match-header">
            <view class="match-type">{{match.eventType}}</view>
            <view class="match-status">
              <text class="status-label {{match.status === '已结束' ? 'status-completed' : match.status === '比赛中' ? 'status-ongoing' : 'status-registration'}}">
                <text wx:if="{{match.status === '比赛中'}}" class="live-dot">●</text>
                {{match.status === '已结束' ? '已结束' : match.status === '比赛中' ? '进行中' : '报名中'}}
              </text>
            </view>
          </view>
          
          <!-- 比赛场地和时间信息 -->
          <view class="match-info">
            <text class="venue-info">📍 {{match.venue}} - {{match.stage}}</text>
            <text class="time-info">🕐 {{formatMatchTime(match.scheduledTime)}}</text>
            <text class="region-info">🌍 {{match.region}}</text>
          </view>
          
          <!-- 选手和比分 -->
          <view class="players-section">
            <!-- 队伍1 -->
            <view class="team-row {{match.score && match.score.winner === 'team1' ? 'winner' : ''}}">
              <view class="team-players">
                <view wx:for="{{match.players.team1}}" wx:for-item="player" wx:for-index="playerIndex" wx:key="playerIndex" class="player">
                  <text class="player-name">{{player.name}}</text>
                  <text class="player-ranking">({{player.ranking}})</text>
                </view>
              </view>
              
              <!-- 队伍1比分 -->
              <view class="team-score">
                <view wx:for="{{match.score.sets}}" wx:for-item="set" wx:key="setNumber" 
                      class="set-score {{set.team1Score > set.team2Score ? 'winner' : ''}}">
                  {{set.team1Score}}
                  <text wx:if="{{set.tiebreak && set.tiebreak.played}}" class="tiebreak-score">({{set.tiebreak.team1Score}})</text>
                </view>
              </view>
            </view>
            
            <!-- VS 分隔符 -->
            <view class="vs-divider">
              <text wx:if="{{match.score.winner}}" class="winner-mark">{{match.score.winner === 'team1' ? '✓' : ''}}</text>
              <text class="vs-text">VS</text>
              <text wx:if="{{match.score.winner}}" class="winner-mark">{{match.score.winner === 'team2' ? '✓' : ''}}</text>
            </view>
            
            <!-- 队伍2 -->
            <view class="team-row {{match.score && match.score.winner === 'team2' ? 'winner' : ''}}">
              <view class="team-players">
                <view wx:for="{{match.players.team2}}" wx:for-item="player" wx:for-index="playerIndex" wx:key="playerIndex" class="player">
                  <text class="player-name">{{player.name}}</text>
                  <text class="player-ranking">({{player.ranking}})</text>
                </view>
              </view>
              
              <!-- 队伍2比分 -->
              <view class="team-score">
                <view wx:for="{{match.score.sets}}" wx:for-item="set" wx:key="setNumber" 
                      class="set-score {{set.team2Score > set.team1Score ? 'winner' : ''}}">
                  {{set.team2Score}}
                  <text wx:if="{{set.tiebreak && set.tiebreak.played}}" class="tiebreak-score">({{set.tiebreak.team2Score}})</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 比赛统计信息 -->
          <view class="match-stats" wx:if="{{match.matchStats}}">
            <view class="stat-item">
              <text class="stat-icon">👥</text>
              <text class="stat-value">{{match.matchStats.spectatorCount || 0}}</text>
            </view>
            <view class="stat-item">
              <text class="stat-icon">👁</text>
              <text class="stat-value">{{match.matchStats.viewCount || 0}}</text>
            </view>
            <view class="stat-item" wx:if="{{match.matchStats.duration}}">
              <text class="stat-icon">⏱</text>
              <text class="stat-value">{{match.matchStats.duration}}</text>
            </view>
          </view>
          
          <!-- 操作按钮 -->
          <view class="match-actions">
            <button wx:if="{{match.status === '报名中'}}" 
                    class="btn-register" 
                    catchtap="registerMatch" 
                    data-id="{{match._id}}">
              报名参赛
            </button>
            <view wx:elif="{{match.status === '比赛中'}}" class="action-group">
              <button class="btn-spectator" 
                      catchtap="joinAsSpectator" 
                      data-id="{{match._id}}">
                <text class="action-icon">👁</text>
                <text class="action-text">观看</text>
              </button>
              <button class="btn-detail" 
                      catchtap="goToDetail" 
                      data-id="{{match._id}}">
                查看详情
              </button>
            </view>
            <button wx:else 
                    class="btn-detail" 
                    catchtap="goToDetail" 
                    data-id="{{match._id}}">
              查看详情
            </button>
          </view>
        </view>
      </view>
    </block>
    
    <!-- Skeleton Loader -->
    <block wx:if="{{loading && matches.length === 0}}">
      <view class="skeleton-card">
        <view class="skeleton-header"></view>
        <view class="skeleton-content">
          <view class="skeleton-row">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-text-group">
              <view class="skeleton-text short"></view>
              <view class="skeleton-text long"></view>
            </view>
          </view>
          <view class="skeleton-row">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-text-group">
              <view class="skeleton-text short"></view>
              <view class="skeleton-text long"></view>
            </view>
          </view>
          <view class="skeleton-right-section"></view>
        </view>
      </view>
      <view class="skeleton-card">
        <view class="skeleton-header"></view>
        <view class="skeleton-content">
          <view class="skeleton-row">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-text-group">
              <view class="skeleton-text short"></view>
              <view class="skeleton-text long"></view>
            </view>
          </view>
          <view class="skeleton-row">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-text-group">
              <view class="skeleton-text short"></view>
              <view class="skeleton-text long"></view>
            </view>
          </view>
          <view class="skeleton-right-section"></view>
        </view>
      </view>
    </block>

    <!-- Empty State -->
    <view wx:if="{{!loading && matches.length === 0}}" class="empty-state">
      <text class="empty-icon">📭</text>
      <view class="empty-text">暂无比赛数据，尝试调整筛选条件或稍后再试。</view>
    </view>
    
    <!-- Loading State -->
    <view wx:if="{{loading}}" class="loading-state">
      <view class="loading-spinner"></view>
      <view class="loading-text">加载中...</view>
    </view>
    
    <!-- Load More -->
    <view wx:if="{{hasMore && !loading && matches.length > 0}}" class="load-more" bindtap="loadMoreMatches">
      加载更多
    </view>
  </view>
</view> 