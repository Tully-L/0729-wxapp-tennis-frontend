<!-- detail.wxml -->
<view class="container">
  <!-- Header -->
  <view class="header">
    <view class="back-btn" bindtap="goBack">
      <text class="back-icon">â¬…ï¸</text>
      <text>è¿”å›</text>
    </view>
    <view class="header-actions">
      <view class="share-btn" bindtap="shareMatch">
        <text class="share-icon">ğŸ“¤</text>
      </view>
    </view>
  </view>
  
  <!-- Loading State -->
  <view wx:if="{{loading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½æ¯”èµ›è¯¦æƒ…ä¸­...</view>
  </view>
  
  <!-- Error State -->
  <view wx:elif="{{error}}" class="error-state">
    <text class="error-icon">âŒ</text>
    <view class="error-text">åŠ è½½æ¯”èµ›æ•°æ®å¤±è´¥</view>
    <button class="btn-retry" bindtap="loadMatchDetail">é‡è¯•</button>
  </view>
  
  <!-- Match Detail -->
  <block wx:elif="{{match}}">
    <!-- Match Header -->
    <view class="match-header">
      <view class="match-title">
        <text class="event-type">{{match.eventType}}</text>
        <text class="status-label {{match.statusClass}}">
          <text wx:if="{{match.isLive}}" class="live-dot">â—</text>
          {{match.statusText}}
        </text>
      </view>
      <view class="match-subtitle">
        <text class="stage">{{match.stage || 'Match'}}</text>
        <text wx:if="{{match.venue}}" class="venue"> â€¢ {{match.venue}}</text>
        <text wx:if="{{match.region}}" class="region"> â€¢ {{match.region}}</text>
      </view>
      <view class="match-time" wx:if="{{match.scheduledTime}}">
        <text class="time-icon">ğŸ•</text>
        <text class="time-text">{{formatMatchTime(match.scheduledTime)}}</text>
      </view>
    </view>

    <!-- æ¯”èµ›çŠ¶æ€ç®¡ç†ç»„ä»¶ -->
    <match-status
      wx:if="{{match}}"
      match="{{match}}"
      currentStatus="{{match.status}}"
      canManageStatus="{{canManageStatus}}"
      showTimeInfo="{{true}}"
      showHistory="{{false}}"
      statusHistory="{{statusHistory}}"
      bindstatusupdated="onStatusUpdated"
    />

    <!-- Real-time Connection Status -->
    <view class="connection-status" wx:if="{{match.isLive}}">
      <text class="connection-icon {{isConnected ? 'connected' : 'disconnected'}}">â—</text>
      <text class="connection-text">{{isConnected ? 'å®æ—¶è¿æ¥' : 'è¿æ¥ä¸­æ–­'}}</text>
      <text class="last-update" wx:if="{{lastUpdate}}">æœ€åæ›´æ–°: {{lastUpdate}}</text>
    </view>
    
    <!-- Match Info -->
    <view class="match-info">
      <view class="match-format">Format: {{match.format || '3 Sets'}}</view>
      <view class="match-duration" wx:if="{{match.formattedDuration}}">
        Duration: {{match.formattedDuration}}
      </view>
    </view>

    <!-- Subscribe to notifications (Example) -->
    <button wx:if="{{match.status === 'upcoming'}}" class="btn-subscribe" bindtap="subscribeToMatchNotifications">
      è®¢é˜…æ¯”èµ›é€šçŸ¥
    </button>
    
    <!-- è¯¦ç»†æ¯”åˆ†æ˜¾ç¤ºç»„ä»¶ -->
    <score-detail
      match="{{match}}"
      scoreSummary="{{scoreSummary}}"
      matchStats="{{matchStats}}"
      currentGameScore="{{currentGameScore}}"
      displayMode="full"
      bindscoreclick="onScoreClick"
      bindplayerclick="onPlayerClick"
    />

    <!-- æ¯”åˆ†æ›´æ–°æŒ‰é’® -->
    <view class="score-actions" wx:if="{{canUpdateScore && match.isLive}}">
      <button class="btn-update-score" bindtap="showScoreUpdateDialog">
        <text class="btn-icon">ğŸ“</text>
        <text class="btn-text">æ›´æ–°æ¯”åˆ†</text>
      </button>
    </view>
    
    <!-- Match Statistics -->
    <view class="match-statistics" wx:if="{{matchStats}}">
      <view class="stats-title">æ¯”èµ›ç»Ÿè®¡</view>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-icon">ğŸ‘¥</text>
          <text class="stat-label">è§‚ä¼—</text>
          <text class="stat-value">{{matchStats.spectatorCount || 0}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-icon">ğŸ‘</text>
          <text class="stat-label">è§‚çœ‹</text>
          <text class="stat-value">{{matchStats.viewCount || 0}}</text>
        </view>
        <view class="stat-item" wx:if="{{matchStats.duration}}">
          <text class="stat-icon">â±</text>
          <text class="stat-label">æ—¶é•¿</text>
          <text class="stat-value">{{matchStats.duration}}</text>
        </view>
      </view>
    </view>
    
    <!-- Spectator Section -->
    <view class="spectator-section" wx:if="{{match.isLive || match.status === 'upcoming'}}">
      <view class="spectator-header">
        <text class="spectator-title">è§‚ä¼— ({{spectators.length}})</text>
        <button class="btn-spectator {{isSpectator ? 'active' : ''}}" bindtap="joinAsSpectator">
          <text class="spectator-icon">{{isSpectator ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—¨'}}</text>
          <text class="spectator-text">{{isSpectator ? 'é€€å‡ºè§‚çœ‹' : 'åŠ å…¥è§‚çœ‹'}}</text>
        </button>
      </view>
      
      <!-- Spectator List -->
      <view class="spectator-list" wx:if="{{spectators.length > 0}}">
        <view wx:for="{{spectators}}" wx:key="_id" class="spectator-item">
          <text class="spectator-avatar">ğŸ‘¤</text>
          <text class="spectator-name">{{item.nickName || item.name}}</text>
        </view>
      </view>
    </view>
    
    <!-- Match Details -->
    <view class="match-details">
      <view class="detail-section">
        <view class="detail-title">æ¯”èµ›è¯¦æƒ…</view>
        <view class="detail-item">
          <text class="detail-label">èµ›äº‹:</text>
          <text class="detail-value">{{match.eventName || match.eventType}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">ä¸»åŠæ–¹:</text>
          <text class="detail-value">{{match.organizer.name || 'ç½‘çƒçƒ­'}}</text>
        </view>
        <view class="detail-item" wx:if="{{match.venue}}">
          <text class="detail-label">åœºåœ°:</text>
          <text class="detail-value">{{match.venue}}</text>
        </view>
        <view class="detail-item" wx:if="{{match.court}}">
          <text class="detail-label">çƒåœº:</text>
          <text class="detail-value">{{match.court}}</text>
        </view>
        <view class="detail-item" wx:if="{{match.region}}">
          <text class="detail-label">åœ°åŒº:</text>
          <text class="detail-value">{{match.region}}</text>
        </view>
      </view>
    </view>
    
    <!-- Real-time Chat Section -->
    <view class="chat-section" wx:if="{{match.isLive && isConnected}}">
      <view class="chat-header" bindtap="toggleChat">
        <text class="chat-title">å®æ—¶èŠå¤© ({{messages.length}})</text>
        <text class="chat-toggle">{{showChat ? 'â–¼' : 'â–¶'}}</text>
      </view>
      
      <view class="chat-content {{showChat ? 'show' : ''}}" wx:if="{{showChat}}">
        <!-- Chat Messages -->
        <scroll-view class="chat-messages" scroll-y="true" scroll-top="{{999999}}">
          <view wx:for="{{messages}}" wx:key="id" class="chat-message {{item.isOwn ? 'own' : ''}}">
            <view class="message-header">
              <text class="message-avatar">ğŸ‘¤</text>
              <text class="message-user">{{item.userName}}</text>
              <text class="message-time">{{item.timestamp}}</text>
            </view>
            <view class="message-content">{{item.message}}</view>
          </view>
          
          <view wx:if="{{messages.length === 0}}" class="no-messages">
            <text>æš‚æ— èŠå¤©æ¶ˆæ¯</text>
          </view>
        </scroll-view>
        
        <!-- Chat Input -->
        <view class="chat-input-section">
          <input 
            class="chat-input" 
            placeholder="è¾“å…¥æ¶ˆæ¯..." 
            value="{{newMessage}}"
            bindinput="onMessageInput"
            confirm-type="send"
            bindconfirm="sendChatMessage"
          />
          <button class="btn-send" bindtap="sendChatMessage">å‘é€</button>
        </view>
      </view>
    </view>
    
    <!-- Registration Section -->
    <view class="registration-section" wx:if="{{match.status === 'registration'}}">
      <button class="btn-register" bindtap="registerMatch">æŠ¥åå‚åŠ æ­¤æ¯”èµ›</button>
    </view>
  </block>
  
  <!-- Score Update Dialog -->
  <view class="score-update-modal {{showScoreUpdate ? 'show' : ''}}" wx:if="{{showScoreUpdate}}">
    <view class="modal-overlay" bindtap="hideScoreUpdateDialog"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æ›´æ–°æ¯”åˆ† - ç¬¬{{currentSet}}ç›˜</text>
        <view class="modal-close" bindtap="hideScoreUpdateDialog">âœ•</view>
      </view>
      
      <view class="modal-body">
        <view class="score-input-section">
          <view class="team-score-input">
            <text class="team-label">é˜Ÿä¼1</text>
            <input 
              class="score-input" 
              type="number" 
              value="{{team1Score}}" 
              bindinput="onTeam1ScoreChange"
              placeholder="0"
            />
          </view>
          
          <view class="vs-separator">VS</view>
          
          <view class="team-score-input">
            <text class="team-label">é˜Ÿä¼2</text>
            <input 
              class="score-input" 
              type="number" 
              value="{{team2Score}}" 
              bindinput="onTeam2ScoreChange"
              placeholder="0"
            />
          </view>
        </view>
        
        <!-- Tiebreak Toggle -->
        <view class="tiebreak-section">
          <view class="tiebreak-toggle" bindtap="toggleTiebreak">
            <text class="toggle-label">æŠ¢ä¸ƒå±€</text>
            <view class="toggle-switch {{tiebreakMode ? 'active' : ''}}">
              <view class="toggle-handle"></view>
            </view>
          </view>
          
          <!-- Tiebreak Scores -->
          <view class="tiebreak-inputs" wx:if="{{tiebreakMode}}">
            <view class="tiebreak-input-group">
              <text class="tiebreak-label">é˜Ÿä¼1æŠ¢ä¸ƒ</text>
              <input 
                class="tiebreak-input" 
                type="number" 
                value="{{tiebreakTeam1}}" 
                bindinput="onTiebreakTeam1Change"
                placeholder="0"
              />
            </view>
            <view class="tiebreak-input-group">
              <text class="tiebreak-label">é˜Ÿä¼2æŠ¢ä¸ƒ</text>
              <input 
                class="tiebreak-input" 
                type="number" 
                value="{{tiebreakTeam2}}" 
                bindinput="onTiebreakTeam2Change"
                placeholder="0"
              />
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideScoreUpdateDialog">å–æ¶ˆ</button>
        <button class="btn-submit" bindtap="submitScoreUpdate">æäº¤</button>
      </view>
    </view>
  </view>
</view> 